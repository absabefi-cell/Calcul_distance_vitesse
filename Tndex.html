<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>GPS â€¢ Distance, Vitesse & Carte</title>

<!-- Leaflet (carte) -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background: #f0f2f5;
    }
    h1 {
        background: #2a6efc;
        color: white;
        padding: 18px;
        text-align: center;
        margin: 0;
        font-size: 24px;
    }
    .section {
        background: white;
        padding: 18px;
        margin: 15px;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    button {
        background: #2a6efc;
        border: none;
        padding: 10px 14px;
        color: white;
        border-radius: 8px;
        margin: 5px 5px 5px 0;
        font-size: 15px;
    }
    button:hover { background: #1f5ae0; }
    .value {
        font-weight: bold;
        color: #2a6efc;
        font-size: 18px;
    }
    #gpsStatus {
        padding: 8px;
        font-weight: bold;
        border-radius: 6px;
        margin-bottom: 10px;
    }
    .ok   { background: #d1ffd4; color: #0f7d1f; }
    .wait { background: #fff3d1; color: #aa7a00; }
    .bad  { background: #ffd1d1; color: #a80000; }
    #log, #logSpeed {
        font-size: 13px;
        white-space: pre-line;
        background: #f8f8f8;
        padding: 10px;
        border-radius: 8px;
        margin-top: 10px;
        max-height: 200px;
        overflow-y: auto;
    }
    #map {
        width: 100%;
        height: 300px;
        border-radius: 10px;
        margin-top: 10px;
    }
</style>
</head>
<body>

<h1>GPS â€¢ Distance, Vitesse & Carte</h1>

<!-- Ã‰tat GPS -->
<div class="section">
    <h2>Ã‰tat du GPS</h2>
    <div id="gpsStatus" class="wait">ðŸŸ¡ En attente du signal GPSâ€¦</div>
    <p>â€¢ Le premier fix peut Ãªtre lent sans internet (20â€“60 s).</p>
    <p>â€¢ Tester dehors pour une meilleure prÃ©cision.</p>
</div>

<!-- Carte -->
<div class="section">
    <h2>Carte (OpenStreetMap)</h2>
    <p>â€¢ Pointe bleue = position actuelle<br>
       â€¢ A = point de dÃ©part<br>
       â€¢ B = point dâ€™arrivÃ©e<br>
       â€¢ Ligne bleue = trajet parcouru pendant le suivi</p>
    <div id="map"></div>
</div>

<!-- Distance Aâ€“B -->
<div class="section">
    <h2>1) Distance entre deux points (A â†’ B)</h2>

    <button onclick="savePointA()">Enregistrer Point A</button>
    <p id="coordA">Point A : â€”</p>

    <button onclick="savePointB()">Enregistrer Point B</button>
    <p id="coordB">Point B : â€”</p>

    <button onclick="computeDistance()">Calculer la distance Aâ€“B</button>

    <h3>Distance Aâ€“B :</h3>
    <div class="value" id="distAB">â€”</div>

    <div id="log"></div>
</div>

<!-- Vitesse temps rÃ©el -->
<div class="section">
    <h2>2) Suivi en temps rÃ©el (vitesse & distance)</h2>

    <button onclick="startTracking()">DÃ©marrer le suivi</button>
    <button onclick="stopTracking()">ArrÃªter</button>

    <p>Vitesse instantanÃ©e : <span class="value" id="speed">â€”</span> km/h</p>
    <p>Vitesse moyenne : <span class="value" id="speedAvg">â€”</span> km/h</p>
    <p>Distance totale : <span class="value" id="distTotal">0.00</span> m</p>
    <p>Temps Ã©coulÃ© : <span class="value" id="elapsed">00:00</span></p>

    <div id="logSpeed"></div>
</div>

<script>
// =======================
//  CARTE (Leaflet)
// =======================
let map = null;
let liveMarker = null;
let markerA = null;
let markerB = null;
let trackPolyline = null;
let trackPoints = [];

function initMap(lat, lon) {
    if (map) return;

    map = L.map('map').setView([lat, lon], 18);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    liveMarker = L.marker([lat, lon], {title: "Position actuelle"}).addTo(map);
}

function updateLiveMarker(lat, lon) {
    if (!map) initMap(lat, lon);
    liveMarker.setLatLng([lat, lon]);
}

function setMarkerA(lat, lon) {
    if (!map) initMap(lat, lon);
    if (markerA) markerA.remove();
    markerA = L.marker([lat, lon], {title: "Point A"}).addTo(map);
}

function setMarkerB(lat, lon) {
    if (!map) initMap(lat, lon);
    if (markerB) markerB.remove();
    markerB = L.marker([lat, lon], {title: "Point B"}).addTo(map);
}

// =======================
//  INDICATEUR GPS
// =======================
function updateGPS(status) {
    const el = document.getElementById("gpsStatus");
    if (status === "good") {
        el.className = "ok";
        el.textContent = "ðŸŸ¢ GPS OK â€” signal reÃ§u";
    } else if (status === "wait") {
        el.className = "wait";
        el.textContent = "ðŸŸ¡ En attente du signal GPSâ€¦";
    } else {
        el.className = "bad";
        el.textContent = "ðŸ”´ GPS refusÃ© ou indisponible";
    }
}

// =======================
//  DISTANCE A â†’ B
// =======================
let pointA = null;
let pointB = null;

function savePointA() {
    updateGPS("wait");
    navigator.geolocation.getCurrentPosition(pos => {
        updateGPS("good");
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        pointA = { lat, lon };
        document.getElementById("coordA").textContent =
            "Point A : " + lat.toFixed(6) + ", " + lon.toFixed(6);
        setMarkerA(lat, lon);
        updateLiveMarker(lat, lon);
    }, err => {
        updateGPS("bad");
        alert("Erreur GPS (A) : " + err.message);
    }, { enableHighAccuracy: true, timeout: 60000 });
}

function savePointB() {
    updateGPS("wait");
    navigator.geolocation.getCurrentPosition(pos => {
        updateGPS("good");
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        pointB = { lat, lon };
        document.getElementById("coordB").textContent =
            "Point B : " + lat.toFixed(6) + ", " + lon.toFixed(6);
        setMarkerB(lat, lon);
        updateLiveMarker(lat, lon);
    }, err => {
        updateGPS("bad");
        alert("Erreur GPS (B) : " + err.message);
    }, { enableHighAccuracy: true, timeout: 60000 });
}

function computeDistance() {
    if (!pointA || !pointB) {
        alert("Enregistre dâ€™abord les points A et B.");
        return;
    }
    const d = haversine(pointA.lat, pointA.lon, pointB.lat, pointB.lon);
    document.getElementById("distAB").textContent = d.toFixed(2) + " m";

    document.getElementById("log").textContent =
        `A = (${pointA.lat.toFixed(6)}, ${pointA.lon.toFixed(6)})\n` +
        `B = (${pointB.lat.toFixed(6)}, ${pointB.lon.toFixed(6)})\n` +
        `Distance Ã  vol d'oiseau = ${d.toFixed(2)} m\n\n` +
        document.getElementById("log").textContent;
}

// =======================
//  VITESSE TEMPS RÃ‰EL + TRAJET BLEU
// =======================
let watchId = null;
let lastPos = null;
let lastTime = null;
let totalDist = 0;
let startTime = null;

function startTracking() {
    if (watchId !== null) return; // dÃ©jÃ  en cours

    totalDist = 0;
    lastPos = null;
    lastTime = null;
    startTime = null;
    trackPoints = [];
    if (trackPolyline) {
        trackPolyline.remove();
        trackPolyline = null;
    }

    document.getElementById("distTotal").textContent = "0.00";
    document.getElementById("speed").textContent = "â€”";
    document.getElementById("speedAvg").textContent = "â€”";
    document.getElementById("elapsed").textContent = "00:00";
    document.getElementById("logSpeed").textContent = "";
    updateGPS("wait");

    watchId = navigator.geolocation.watchPosition(pos => {
        const now = Date.now();
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;

        updateGPS("good");
        updateLiveMarker(lat, lon);

        if (!startTime) startTime = now; // premier point

        // Ajout du point dans le trajet
        trackPoints.push([lat, lon]);
        if (!trackPolyline) {
            trackPolyline = L.polyline(trackPoints, {color: 'blue'}).addTo(map);
        } else {
            trackPolyline.setLatLngs(trackPoints);
        }

        if (lastPos) {
            const dt = (now - lastTime) / 1000;    // secondes
            const d = haversine(lastPos.lat, lastPos.lon, lat, lon); // mÃ¨tres

            if (dt > 0 && d > 0.5) { // filtre bruit GPS
                totalDist += d;
                const v_ms = d / dt;
                const v_kmh = v_ms * 3.6;

                // temps total depuis le dÃ©but
                const elapsedSec = (now - startTime) / 1000;
                const avg_ms = totalDist / elapsedSec;
                const avg_kmh = avg_ms * 3.6;

                document.getElementById("speed").textContent = v_kmh.toFixed(2);
                document.getElementById("speedAvg").textContent = avg_kmh.toFixed(2);
                document.getElementById("distTotal").textContent = totalDist.toFixed(2);
                document.getElementById("elapsed").textContent = formatTime(elapsedSec);

                document.getElementById("logSpeed").textContent =
                    `Î”t=${dt.toFixed(1)}s | d=${d.toFixed(2)}m | v=${v_kmh.toFixed(2)} km/h\n` +
                    document.getElementById("logSpeed").textContent;
            }
        }

        lastPos = { lat, lon };
        lastTime = now;

    }, err => {
        updateGPS("bad");
        alert("Erreur GPS (suivi) : " + err.message);
    }, { enableHighAccuracy: true, timeout: 60000 });
}

function stopTracking() {
    if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
    }
    updateGPS("wait");
}

// =======================
//  OUTILS
// =======================
function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = x => x * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const Ï†1 = toRad(lat1);
    const Ï†2 = toRad(lat2);
    const a =
        Math.sin(dLat/2)**2 +
        Math.cos(Ï†1) * Math.cos(Ï†2) * Math.sin(dLon/2)**2;
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function formatTime(sec) {
    sec = Math.floor(sec);
    const m = Math.floor(sec / 60);
    const s = sec % 60;
    const mm = m.toString().padStart(2, "0");
    const ss = s.toString().padStart(2, "0");
    return `${mm}:${ss}`;
}
</script>

</body>
</html>
